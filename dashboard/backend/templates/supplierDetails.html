<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails du Fournisseur | Ecovision</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/recommandationstyle.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.0/chart.min.js"></script>
</head>
<body>
    <header>
        <div class="header-container">
            <div class="logo">
                <i class="fas fa-leaf"></i>
                <h1>Eco<span>VISION</span></h1>
            </div>
            <nav>
                <ul>
                    <li><a href="/"><i class="fas fa-home"></i> Accueil</a></li>
                    <li><a href="/recommendations"><i class="fas fa-award"></i> Recommandations</a></li>
                    <li><a href="#" id="analysisBtn"><i class="fas fa-brain"></i> Analyse IA</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="details-page">
        <div class="breadcrumb">
            <a href="/">Accueil</a> &gt; 
            <a href="/recommendations">Recommandations</a> &gt; 
            <span id="supplierBreadcrumb">Détails du fournisseur</span>
        </div>

        <div id="loadingDetails" class="loading">
            <div class="spinner"></div>
            <p>Chargement des détails du fournisseur...</p>
        </div>

        <div id="supplierDetails" class="supplier-details-container" style="display: none;">
            <div class="supplier-header">
                <div class="supplier-info">
                    <h2 id="supplierName">Nom du fournisseur</h2>
                    <p id="supplierLocation"><i class="fas fa-map-marker-alt"></i> <span>Localisation</span></p>
                </div>
                <div class="supplier-score-card">
                    <div class="score-circle">
                        <svg width="120" height="120" viewBox="0 0 120 120">
                            <circle cx="60" cy="60" r="54" fill="none" stroke="#e6e6e6" stroke-width="12" />
                            <circle id="scoreCircle" cx="60" cy="60" r="54" fill="none" stroke="#4caf50" stroke-width="12" 
                                    stroke-dasharray="339.292" stroke-dashoffset="0" transform="rotate(-90 60 60)" />
                        </svg>
                        <div class="score-text">
                            <span id="scoreValue">0</span>
                            <span class="score-label">/100</span>
                        </div>
                    </div>
                    <p class="score-title">Score de durabilité</p>
                </div>
            </div>

            <div class="details-metrics">
                <div class="metrics-section">
                    <h3>Indicateurs clés</h3>
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-solar-panel"></i></div>
                            <div class="metric-info">
                                <h4>Énergie renouvelable</h4>
                                <p id="renewableEnergy">0%</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-cloud"></i></div>
                            <div class="metric-info">
                                <h4>Empreinte carbone</h4>
                                <p id="carbonFootprint">0 kgCO2e</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-tint"></i></div>
                            <div class="metric-info">
                                <h4>Consommation d'eau</h4>
                                <p id="waterConsumption">0 L</p>
                            </div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-icon"><i class="fas fa-truck-moving"></i></div>
                            <div class="metric-info">
                                <h4>Transport</h4>
                                <p id="transportType">Type</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-charts">
                    <div class="chart-container">
                        <h3>Analyse des composantes du score</h3>
                        <canvas id="scoreComponentsChart"></canvas>
                    </div>
                </div>

                <div class="supplier-details-section">
                    <h3>Informations supplémentaires</h3>
                    <div class="details-table">
                        <div class="details-row">
                            <div class="detail-label">ID Fournisseur</div>
                            <div class="detail-value" id="supplierId">-</div>
                        </div>
                        <div class="details-row">
                            <div class="detail-label">Certifications environnementales</div>
                            <div class="detail-value" id="certifications">-</div>
                        </div>
                        <div class="details-row">
                            <div class="detail-label">Programme de durabilité</div>
                            <div class="detail-value" id="sustainabilityProgram">-</div>
                        </div>
                        <div class="details-row">
                            <div class="detail-label">Distance de transport moyenne</div>
                            <div class="detail-value" id="transportDistance">-</div>
                        </div>
                        <div class="details-row">
                            <div class="detail-label">Matériaux fournis</div>
                            <div class="detail-value" id="materialsSupplied">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="actions-container">
                <button id="contactBtn" class="btn primary-btn"><i class="fas fa-envelope"></i> Contacter le fournisseur</button>
                <button id="compareBtn" class="btn secondary-btn"><i class="fas fa-balance-scale"></i> Comparer</button>
                <button id="reportBtn" class="btn outline-btn"><i class="fas fa-file-pdf"></i> Télécharger le rapport</button>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-container">
            <div class="footer-logo">
                <i class="fas fa-leaf"></i>
                <h2>Eco<span>VISION</span></h2>
            </div>
            <div class="footer-links">
                <h3>Liens rapides</h3>
                <ul>
                    <li><a href="/">Accueil</a></li>
                    <li><a href="/recommendations">Recommandations</a></li>
                    <li><a href="#">À propos</a></li>
                    <li><a href="#">Contact</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h3>Contact</h3>
                <p><i class="fas fa-envelope"></i> contact@ecosupplyinsight.com</p>
                <p><i class="fas fa-phone"></i> +216 1 23 45 67 89</p>
            </div>
        </div>
        <div class="copyright">
            <p>&copy; 2025 EcoVision. Tous droits réservés.</p>
        </div>
    </footer>

    <!-- Modal de contact -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2><i class="fas fa-envelope"></i> Contacter le fournisseur</h2>
            <form id="contactForm" class="contact-form">
                <div class="form-group">
                    <label for="contactName">Votre nom</label>
                    <input type="text" id="contactName" required>
                </div>
                <div class="form-group">
                    <label for="contactEmail">Votre email</label>
                    <input type="email" id="contactEmail" required>
                </div>
                <div class="form-group">
                    <label for="contactSubject">Sujet</label>
                    <input type="text" id="contactSubject" required>
                </div>
                <div class="form-group">
                    <label for="contactMessage">Message</label>
                    <textarea id="contactMessage" rows="5" required></textarea>
                </div>
                <button type="submit" class="btn primary-btn">Envoyer</button>
            </form>
        </div>
    </div>

    <script>
        // ID du fournisseur depuis l'URL
        const supplierId = "{{ supplier_id }}";
        
        document.addEventListener('DOMContentLoaded', () => {
            loadSupplierDetails(supplierId);
            
            // Gestionnaire pour le bouton de contact
            document.getElementById('contactBtn').addEventListener('click', () => {
                const modal = document.getElementById('contactModal');
                modal.style.display = "block";
            });
            
            // Fermeture du modal
            document.querySelectorAll('.close').forEach(element => {
                element.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.style.display = "none";
                    });
                });
            });
            
            // Fermer le modal en cliquant en dehors
            window.addEventListener('click', (event) => {
                document.querySelectorAll('.modal').forEach(modal => {
                    if (event.target == modal) {
                        modal.style.display = "none";
                    }
                });
            });
            
            // Formulaire de contact
            document.getElementById('contactForm').addEventListener('submit', (e) => {
                e.preventDefault();
                alert('Votre message a été envoyé avec succès!');
                document.getElementById('contactModal').style.display = "none";
            });
        });
        
        async function loadSupplierDetails(supplierId) {
            try {
                // Afficher l'indicateur de chargement
                document.getElementById('loadingDetails').style.display = 'flex';
                document.getElementById('supplierDetails').style.display = 'none';
                
                console.log(`Chargement des détails pour le fournisseur ID: ${supplierId}`);
                
                const response = await fetch(`/api/supplier_details/${supplierId}`);
                if (!response.ok) {
                    throw new Error(`Erreur HTTP: ${response.status}`);
                }
                
                const supplier = await response.json();
                console.log("Données du fournisseur reçues:", supplier);
                
                displaySupplierDetails(supplier);
            } catch (error) {
                console.error('Erreur lors du chargement des détails:', error);
                document.getElementById('loadingDetails').innerHTML = `
                    <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Impossible de charger les détails du fournisseur: ${error.message}</p>
                        <button onclick="location.reload()" class="btn primary-btn">Réessayer</button>
                    </div>
                `;
            }
        }
        
   function displaySupplierDetails(supplier) {
    // Vérifier si les données du fournisseur sont valides
    if (!supplier) {
        throw new Error("Données du fournisseur invalides");
    }
    
    // Masquer le chargement et afficher les détails
    document.getElementById('loadingDetails').style.display = 'none';
    document.getElementById('supplierDetails').style.display = 'block';
    
    // Informations de base
    document.getElementById('supplierName').textContent = supplier.supplier_name || "Nom inconnu";
    document.getElementById('supplierLocation').querySelector('span').textContent = supplier.location || "Localisation inconnue";
    document.getElementById('supplierBreadcrumb').textContent = supplier.supplier_name || "Détails du fournisseur";
    document.getElementById('supplierId').textContent = supplier.supplier_id || "-";
    
    // Score de durabilité - Assurez-vous que le score est un nombre valide
    const score = parseFloat(supplier.sustainability_score) || 0;
    document.getElementById('scoreValue').textContent = score.toFixed(1);
    
    // Animation du cercle de score
    const circle = document.getElementById('scoreCircle');
    const radius = circle.r.baseVal.value;
    const circumference = 2 * Math.PI * radius;
    
    // Définir strokeDasharray pour le cercle complet
    circle.style.strokeDasharray = `${circumference} ${circumference}`;
    
    // Calculer le décalage pour représenter le pourcentage du score
    // La formule ci-dessous: offset = circumference - (score / 100 * circumference)
    const offset = circumference - (score / 100 * circumference);
    
    // Appliquer le décalage avec un délai pour permettre l'animation
    setTimeout(() => {
        circle.style.strokeDashoffset = offset;
        circle.style.transition = 'stroke-dashoffset 1s ease-in-out';
    }, 100);
    
    // Couleur du cercle selon le score
    if (score >= 75) {
        circle.style.stroke = '#4caf50'; // Vert
    } else if (score >= 50) {
        circle.style.stroke = '#ff9800'; // Orange
    } else {
        circle.style.stroke = '#f44336'; // Rouge
    }
    
    // Métriques clés - Avec vérification de type et valeurs par défaut
    document.getElementById('renewableEnergy').textContent = supplier.renewable_energy_percentage !== undefined ? 
        `${Number(supplier.renewable_energy_percentage).toFixed(1)}%` : "N/A";
        
    document.getElementById('carbonFootprint').textContent = supplier.avg_carbon_footprint !== undefined ? 
        `${Number(supplier.avg_carbon_footprint).toFixed(2)} kgCO2e` : "N/A";
        
    document.getElementById('waterConsumption').textContent = supplier.avg_water_consumption !== undefined ? 
        `${Number(supplier.avg_water_consumption).toFixed(1)} L` : "N/A";
        
    document.getElementById('transportType').textContent = supplier.transport_type || "Non spécifié";
    
    document.getElementById('transportDistance').textContent = supplier.avg_transport_distance !== undefined ? 
        `${Number(supplier.avg_transport_distance).toFixed(1)} km` : "N/A";
        
    document.getElementById('materialsSupplied').textContent = supplier.materials_supplied || "N/A";
    
    // Informations supplémentaires
    document.getElementById('certifications').textContent = supplier.environmental_certifications || 'Aucune certification';
    document.getElementById('sustainabilityProgram').textContent = supplier.sustainability_program || 'Aucun programme';
    
    // Graphique des composantes du score
    createScoreComponentsChart(supplier);
}
        
        function createScoreComponentsChart(supplier) {
            const ctx = document.getElementById('scoreComponentsChart').getContext('2d');
            
            // Calcul des scores de composantes si non disponibles directement
            // Création de scores par défaut ou calcul basé sur les données disponibles
            const calculateComponentScores = (supplier) => {
                const renewable_energy_score = supplier.renewable_energy_percentage_score || 
                    (supplier.renewable_energy_percentage ? (supplier.renewable_energy_percentage / 4) : 0);
                
                const carbon_footprint_score = supplier.avg_carbon_footprint_score || 
                    (supplier.avg_carbon_footprint ? (15 - Math.min(15, supplier.avg_carbon_footprint / 10)) : 0);
                
                const water_consumption_score = supplier.avg_water_consumption_score || 
                    (supplier.avg_water_consumption ? (15 - Math.min(15, supplier.avg_water_consumption / 100)) : 0);
                
                // Utiliser des valeurs dérivées pour les scores de transport
                const transport_score = supplier.transport_score || 
                    (supplier.transport_type ? (supplier.transport_type.toLowerCase().includes('maritime') ? 10 : 
                                                supplier.transport_type.toLowerCase().includes('ferroviaire') ? 8 : 
                                                supplier.transport_type.toLowerCase().includes('camion') ? 5 : 4) : 0);
                
                // Utiliser des valeurs dérivées pour les scores de certification
                const cert_score = supplier.cert_score || 
                    (supplier.environmental_certifications ? 
                     Math.min(10, supplier.environmental_certifications.split(',').length * 2) : 0);
                
                // Utiliser des valeurs dérivées pour les scores de programme de durabilité
                const program_score = supplier.program_score || 
                    (supplier.sustainability_program && supplier.sustainability_program.length > 10 ? 10 : 0);
                
                return {
                    renewable_energy_score,
                    carbon_footprint_score,
                    water_consumption_score,
                    transport_score,
                    cert_score,
                    program_score
                };
            };
            
            // Récupérer ou calculer les scores des composantes
            const scores = calculateComponentScores(supplier);
            
            // Récupération des composantes du score
            const components = [
                { name: 'Énergie renouvelable', value: scores.renewable_energy_score },
                { name: 'Empreinte carbone', value: scores.carbon_footprint_score },
                { name: 'Consommation d\'eau', value: scores.water_consumption_score },
                { name: 'Transport', value: scores.transport_score },
                { name: 'Certifications', value: scores.cert_score },
                { name: 'Programme de durabilité', value: scores.program_score }
            ];
            
            // Création du graphique radar
            const chart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: components.map(c => c.name),
                    datasets: [{
                        label: 'Score par composante',
                        data: components.map(c => c.value),
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        pointBackgroundColor: 'rgba(75, 192, 192, 1)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgba(75, 192, 192, 1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                display: true
                            },
                            suggestedMin: 0,
                            suggestedMax: 25
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>