<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Prédicteur d'Indicateurs Environnementaux</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <header>
        <nav>
            <div class="logo">EcoPredict</div>
            <ul>
                <li><a href="/" class="active">Prédictions</a></li>
             
            </ul>
        </nav>
    </header>

    <main>
        <section class="prediction-form">
            <h1>Prédiction d'Indicateurs Environnementaux</h1>
            <p>Utilisez cet outil pour prédire l'évolution des indicateurs environnementaux et de durabilité.</p>

            <form id="predictionForm">
                <div class="form-group">
                    <label for="metric_type">Type d'indicateur</label>
                    <select id="metric_type" name="metric_type" required>
                        <option value="" disabled selected>-- Sélectionnez un indicateur --</option>
                        <option value="carbon_footprint">Empreinte carbone</option>
                        <option value="water_consumption">Consommation d'eau</option>
                        <option value="energy_consumption">Consommation d'énergie</option>
                        <option value="climate_co2">Niveau de CO2</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="entity_id">Entité</label>
                    <select id="entity_id" name="entity_id">
                        <option value="">Toutes les entités</option>
                        <!-- Options seront chargées dynamiquement -->
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="start_date">Date de début</label>
                        <input type="date" id="start_date" name="start_date">
                    </div>

                    <div class="form-group">
                        <label for="end_date">Date de fin</label>
                        <input type="date" id="end_date" name="end_date">
                    </div>
                </div>

                <div class="form-group">
                    <label for="periods">Périodes à prédire (jours)</label>
                    <input type="number" id="periods" name="periods" value="30" min="1" max="365">
                </div>

                <button type="submit" class="btn-primary">Générer les prédictions</button>
            </form>
        </section>

        <section id="results" class="results hidden">
            <div class="results-header">
                <h2>Résultats de la prédiction</h2>
                <span id="entity-name"></span>
            </div>

            <div class="chart-container">
                <img id="prediction-chart" src="https://cdn-icons-png.flaticon.com/512/12492/12492225.png" alt="Graphique de prédiction">
            </div>

            <div class="metrics-grid">
                <div class="metric-card">
                    <h3>Valeur actuelle</h3>
                    <div id="latest-value" class="metric-value">--</div>
                </div>
                <div class="metric-card">
                    <h3>Tendance</h3>
                    <div id="trend" class="metric-value">--</div>
                </div>
                <div class="metric-card">
                    <h3>Prédiction (7 jours)</h3>
                    <div id="short-term" class="metric-value">--</div>
                </div>
                <div class="metric-card">
                    <h3>Prédiction (30 jours)</h3>
                    <div id="medium-term" class="metric-value">--</div>
                </div>
            </div>

            <div class="analysis-container">
                <div class="impact-card">
                    <h3>Impact environnemental</h3>
                    <div id="impact-indicator" class="impact-neutral">Neutre</div>
                </div>
                
                <div class="recommendations">
                    <h3>Recommandations</h3>
                    <ul id="recommendations-list">
                        <!-- Recommandations seront insérées ici -->
                    </ul>
                </div>
            </div>
        </section>

        <div id="loading" class="loading hidden">
            <div class="spinner"></div>
            <p>Traitement en cours...</p>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 EcoPredict - Tous droits réservés</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const metricSelect = document.getElementById('metric_type');
            const entitySelect = document.getElementById('entity_id');
            const form = document.getElementById('predictionForm');
            const resultsSection = document.getElementById('results');
            const loadingIndicator = document.getElementById('loading');
            
            // Définir les dates par défaut
            const today = new Date();
            const oneYearAgo = new Date();
            oneYearAgo.setFullYear(today.getFullYear() - 1);
            
            document.getElementById('end_date').value = today.toISOString().split('T')[0];
            document.getElementById('start_date').value = oneYearAgo.toISOString().split('T')[0];
            
            // Charger les entités lorsque le type de métrique change
            metricSelect.addEventListener('change', function() {
                loadEntities(this.value);
            });
            
            // Charger les entités
            function loadEntities(metricType) {
                if (!metricType) return;
                
                fetch(`/entities?metric_type=${metricType}`)
                    .then(response => response.json())
                    .then(data => {
                        entitySelect.innerHTML = '<option value="">Toutes les entités</option>';
                        
                        if (data.success && data.entities) {
                            data.entities.forEach(entity => {
                                const option = document.createElement('option');
                                option.value = entity;
                                option.textContent = entity;
                                entitySelect.appendChild(option);
                            });
                        }
                    })
                    .catch(error => console.error('Erreur lors du chargement des entités:', error));
            }
            
            // Gérer la soumission du formulaire
            form.addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Afficher l'indicateur de chargement
                loadingIndicator.classList.remove('hidden');
                resultsSection.classList.add('hidden');
                
                // Collecter les données du formulaire
                const formData = new FormData(form);
                
                // Envoyer les données
                fetch('/predict', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    // Cacher l'indicateur de chargement
                    loadingIndicator.classList.add('hidden');
                    
                    if (data.success) {
                        // Afficher les résultats
                        displayResults(data);
                        resultsSection.classList.remove('hidden');
                    } else {
                        alert('Erreur: ' + (data.error || 'Une erreur est survenue'));
                    }
                })
                .catch(error => {
                    loadingIndicator.classList.add('hidden');
                    console.error('Erreur:', error);
                    alert('Erreur de connexion au serveur');
                });
            });
            
            // Afficher les résultats
            function displayResults(data) {
                // Afficher le graphique
                document.getElementById('prediction-chart').src = `data:image/png;base64,${data.plot}`;
                
                // Afficher le nom de l'entité
                document.getElementById('entity-name').textContent = data.entity_name || 'Toutes les entités';
                
                // Afficher les métriques
                document.getElementById('latest-value').textContent = formatValue(data.metrics.latest_value, data.metric_type);
                document.getElementById('trend').textContent = `${data.metrics.trend_percentage.toFixed(2)}%`;
                document.getElementById('trend').className = 'metric-value ' + getTrendClass(data.metrics.trend_percentage, data.metric_type);
                
                document.getElementById('short-term').textContent = formatValue(data.metrics.short_term_prediction, data.metric_type);
                document.getElementById('medium-term').textContent = formatValue(data.metrics.medium_term_prediction, data.metric_type);
                
                // Afficher l'impact
                const impactIndicator = document.getElementById('impact-indicator');
                impactIndicator.textContent = capitalizeFirstLetter(data.analysis.impact);
                impactIndicator.className = `impact-${data.analysis.impact}`;
                
                // Afficher les recommandations
                const recList = document.getElementById('recommendations-list');
                recList.innerHTML = '';
                data.analysis.recommendations.forEach(rec => {
                    const li = document.createElement('li');
                    li.textContent = rec;
                    recList.appendChild(li);
                });
            }
            
            // Formatter les valeurs selon le type de métrique
            function formatValue(value, metricType) {
                if (value === null || value === undefined) return '--';
                
                if (metricType === 'carbon_footprint') {
                    return `${value.toFixed(2)} kg CO2e`;
                } else if (metricType === 'water_consumption') {
                    return `${value.toFixed(2)} L`;
                } else if (metricType === 'energy_consumption') {
                    return `${value.toFixed(2)} kWh`;
                } else if (metricType === 'climate_co2') {
                    return `${value.toFixed(2)} ppm`;
                }
                return value.toFixed(2);
            }
            
            // Déterminer la classe CSS pour la tendance
            function getTrendClass(trend, metricType) {
                if (metricType === 'carbon_footprint' || metricType === 'water_consumption' || 
                    metricType === 'energy_consumption' || metricType === 'climate_co2') {
                    return trend > 0 ? 'negative' : trend < 0 ? 'positive' : '';
                }
                return trend > 0 ? 'positive' : trend < 0 ? 'negative' : '';
            }
            
            // Mettre la première lettre en majuscule
            function capitalizeFirstLetter(string) {
                return string.charAt(0).toUpperCase() + string.slice(1);
            }
        });
    </script>
</body>
</html>